#!/usr/bin/env bash

# Gum driven CuriOS Manager.
# Control everything related to CuriOS from here.
#
# Dependencies: gum, tte, curios-update, curios-dotfiles

__dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
#------------- Source files
source "${__dir}/constants.sh"
source "${__dir}/functions/app_menu.sh"
source "${__dir}/functions/backup_menu.sh"
source "${__dir}/functions/disk_menu.sh"
source "${__dir}/functions/help_menu.sh"
source "${__dir}/functions/system_menu.sh"
source "${__dir}/functions/main_menu.sh"

#------------- Print help function
usage() {
  echo -e "CuriOS Manager version ${SCRIPT_VERSION}
* modern script interface for managing your CuriOS system *

${GREY}USAGE:${NC}
  curios-manager [options]

${GREY}OPTIONS:${NC}
  ${GREY}-h, --help${NC}         Print this message.
  ${GREY}-v, --verbose${NC}      Print more information.
  ${GREY}--version${NC}          Print version number and exit."
  exit 0
}

#------------- Scripts arguments parse options
ARGS=$(getopt --longoptions="verbose,version,help" --options ":hv" --name "$0" -- "$@")
eval set -- "$ARGS"

while true; do
  case "$1" in
  -v | --verbose)
    VERBOSE=1
    shift
    ;;
  -h | --help)
    usage
    ;;
  --version)
    echo "$SCRIPT_VERSION"
    exit 0
    ;;
  --)
    shift
    break
    ;;
  *)
    break
    ;;
  esac
done

if [ "$VERBOSE" -eq 1 ]; then
  echo -e "Script current path: ${SCRIPT_PATH}"
fi

#precmd() { print -Pn "\e]0;CuriOS Manager" }
# Change terminal title
case $TERM in
alacritty)
  echo -en "\e]2;CuriOS Manager\a"
  ;;
esac

#------------- Check dependencies
available() { command -v "$1" >/dev/null; }

if ! available duf; then
  echo -e "${RED}duf command not found!${NC}"
  exit 2
fi
if ! available fastfetch; then
  echo -e "${RED}fastfetch command not found!${NC}"
  exit 2
fi
if ! available gum; then
  echo -e "${RED}gum command not found!${NC}"
  exit 2
fi
if ! available tte; then
  echo -e "${RED}tte command not found!${NC}"
  exit 2
fi
if ! available fwupdmgr; then
  echo -e "${RED}fwupdmgr command not found!${NC}"
  exit 2
fi
# Get current OS version
if [ ! -f /etc/os-release ]; then
  echo -e "${RED}/etc/os-release file not found!${NC}"
  exit 1
fi
source /etc/os-release

nix_generations() {
  LIST_GEN=$(gum spin --spinner dot --title "Retrieving NixOS information..." -- nixos-rebuild list-generations --json)
  LIST_GEN_DATE=$(echo "$LIST_GEN" | jq -r '.[0].date')
  LIST_GEN_KERNEL=$(echo "$LIST_GEN" | jq -r '.[0].kernelVersion')
}

reboot_check() {
  # Check if a reboot is necessary
  if [[ $(uname -r) != "$LIST_GEN_KERNEL" ]]; then
    echo -e "A new kernel was installed - ${YELLOW}You should REBOOT now${NC}."
    echo -e "${BLUE}Please${NC} ensure that all other applications are properly closed."
    gum confirm "Reboot now:" && sudo reboot now
  fi
}

# CuriOS system check and print warning to user.
warning_print() {
  if [ -f /etc/nixos/user-me.nix ]; then
    gum style --foreground "#ff0000" --border-foreground "#e9d502" --border double --padding "2 4" --align center '/etc/nixos/user-me.nix has been marked as DEPRECATED' 'Copy its content into /etc/nixos/settings.nix and then remove it.'
  fi
}

#------------- starting function
start() {
  clear
  if [ -f /etc/nixos/logo.txt ]; then
    tte -i /etc/nixos/logo.txt --anchor-text c --canvas-width 0 sweep --final-gradient-stops 12488B 2AA1B3 --final-gradient-steps 12 12 --final-gradient-direction diagonal
    #echo -e "${BLUE}CuriOS${NC}"
  else
    echo -e "${RED}/etc/nixos/logo.txt file is missing!${NC}"
  fi
  warning_print
  main_menu
}

start
