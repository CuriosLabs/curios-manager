#!/usr/bin/env bash

# CuriOS update script as NixOS package.
#
# Usage:
#       curios-update [options]
# Options:
#     -h, --help         Print this message.
#     --check            Check online if a most recent version of CuriOS exist.
#     --upgrade          Download latest CuriOS and install it. Implies --check option.
#     -v, --verbose      Print more information.
#     --version          Print version number and exit.
#
# Examples:
#    Check online for the latest version:
#      curios-update --check
#    Upgrade system:
#      curios-update --upgrade

set -eu

#------------- Colors -------------#
readonly RED="\033[31;1m"      # Red and bold
readonly GREEN="\033[32;1m"    # Green and bold
readonly BLUE="\033[34;1m"     # Blue and bold
readonly GREY="\033[37;1m"     # Grey and bold
readonly YELLOW="\033[33;1;3m" # Yellow, bold and italic
readonly NC="\033[0m"          # No Color

#------------- Trap for cleanup
TMP_DIR=$(mktemp -d -t curios-update-XXXXXX)
trap 'rm -rf -- "$TMP_DIR"' EXIT

#------------- Print help function
usage() {
  echo -e "${GREY}USAGE:${NC}
  curios-update [options]

${GREY}OPTIONS:${NC}
  ${GREY}-h, --help${NC}         Print this message.
  ${GREY}--check${NC}            Check online if a most recent version of CuriOS exist.
  ${GREY}--upgrade${NC}          Download latest CuriOS and install it. Implies --check option.
  ${GREY}-v, --verbose${NC}      Print more information.
  ${GREY}--version${NC}          Print version number and exit.

${GREY}EXAMPLES:${NC}
  Check online for the latest version:
    ${GREY}curios-update --check${NC}
  Upgrade system:
    ${GREY}curios-update --upgrade${NC}"
  exit 0
}

#------------- var init state
readonly SCRIPT_VERSION="0.12"
VERBOSE=0
CHECK_ONLINE=0
UPGRADE_SYSTEM=0
UPGRADABLE=0
LATEST_VERSION=""
LATEST_SOURCE=""
NIX_CHANNEL_URL=""
SCRIPT_PATH="$(dirname "$0")"

#------------- Scripts arguments parse options
ARGS=$(getopt --longoptions="verbose,version,help,check,upgrade" --options ":hv" -- "$@")
if [ $# -eq 0 ]; then
  usage
fi

eval set -- "$ARGS"

while true; do
  case "$1" in
  -v | --verbose)
    VERBOSE=1
    shift
    ;;
  -h | --help)
    usage
    ;;
  --check)
    CHECK_ONLINE=1
    shift
    ;;
  --upgrade)
    UPGRADE_SYSTEM=1
    CHECK_ONLINE=1
    shift
    ;;
  --version)
    echo "$SCRIPT_VERSION"
    exit 0
    ;;
  --)
    shift
    break
    ;;
  *)
    break
    ;;
  esac
done

if [ $VERBOSE -eq 1 ]; then
  echo "Script current path: ${SCRIPT_PATH}"
fi

# This script must be run as root for --upgrade option
if [ "$EUID" -ne 0 ] && [ $UPGRADE_SYSTEM -eq 1 ]; then
  echo -e "${RED}This script MUST be run as root: sudo curios-update --upgrade${NC}" >&2
  exit 1
fi

# Check dependencies
available() { command -v "$1" >/dev/null; }

if ! available notify-send; then
  echo -e "${RED}notify-send command not found!${NC}"
  exit 1
fi
if ! available wget; then
  echo -e "${RED}wget command not found!${NC}"
  exit 1
fi
if ! available curl; then
  echo -e "${RED}curl command not found!${NC}"
  exit 1
fi
if ! available jq; then
  echo -e "${RED}jq command not found!${NC}"
  exit 1
fi
if ! available tar; then
  echo -e "${RED}tar command not found!${NC}"
  exit 1
fi
if ! available find; then
  echo -e "${RED}find command not found!${NC}"
  exit 1
fi

# check online latest version
get_latest_version() {
  if [ $VERBOSE -eq 1 ]; then
    echo "Checking github sources..."
  fi
  local LATEST_INFO
  LATEST_INFO=$(curl -f -L --silent "https://api.github.com/repos/CuriosLabs/CuriOS/tags" | jq -r '.[0]')
  LATEST_VERSION=$(echo "$LATEST_INFO" | jq -r '.name')
  LATEST_SOURCE=$(echo "$LATEST_INFO" | jq -r '.tarball_url')
}

# Upgrade the system
upgrade_curios() {
  local extracted_source_path=""

  #echo -e "${YELLOW}WARNING: This upgrade process does not verify the integrity of the downloaded source code.${NC}"
  #echo -e "${YELLOW}This is a security risk if the source repository is compromised.${NC}"
  #gum confirm "Continue with the upgrade?" || exit 0

  echo -e "${GREEN}Downloading ${LATEST_VERSION} sources...${NC}"
  wget -O "${TMP_DIR}/CuriOS-${LATEST_VERSION}".tar.gz --show-progress "$LATEST_SOURCE"
  mkdir -p "${TMP_DIR}/CuriOS-${LATEST_VERSION}"/ && tar -C "${TMP_DIR}/CuriOS-${LATEST_VERSION}"/ -xzf "${TMP_DIR}/CuriOS-${LATEST_VERSION}".tar.gz
  extracted_source_path=$(find "${TMP_DIR}/CuriOS-${LATEST_VERSION}"/ --min-depth 1 --max-depth 1 --type d | head -n 1)
  echo "Sources extracted to ${extracted_source_path}"
  # Checking extracted source
  if [ ! -f "$extracted_source_path"/configuration.nix ]; then
    echo -e "${RED}configuration.nix file not found!${NC}"
    exit 1
  fi

  # Installing
  echo -e "${GREEN}Installing update...${NC}"
  install -D -m 644 -t /etc/nixos/ "$extracted_source_path"/configuration.nix
  if [ ! -f /etc/nixos/settings.nix ]; then
    install -D -m 644 -t /etc/nixos/ "$extracted_source_path"/settings.nix
    echo -e "${YELLOW}Default settings.nix file installed!${NC} Edit /etc/nixos/settings.nix to match your username."
  fi
  if [ ! -f "$extracted_source_path"/logo.txt ]; then
    install -D -m 644 -t /etc/nixos/ "$extracted_source_path"/logo.txt
  fi
  install -D -m 555 -t /etc/nixos/ "$extracted_source_path"/curios-*
  mkdir -p /etc/nixos/modules/
  cp -r -f "$extracted_source_path"/modules/ /etc/nixos/
  mkdir -p /etc/nixos/pkgs/
  cp -r -f "$extracted_source_path"/pkgs/ /etc/nixos/
  # Updating NixOS channel if necessary
  NIX_CHANNEL_URL=$(grep -oP -m 1 'channel\s*=\s*"\K[^"]+' /etc/nixos/configuration.nix)
  if [ -z "$NIX_CHANNEL_URL" ]; then
    echo -e "${RED}Nix channel not found in configuration.nix!${NC}"
    exit 1
  fi
  if nix-channel --list | grep -q "$NIX_CHANNEL_URL"; then
    echo -e "${BLUE}Nix channel is already up-to-date.${NC}"
  else
    echo -e "${YELLOW}Updating Nix channel...${NC}"
    nix-channel --add "$NIX_CHANNEL_URL" nixos
    nix-channel --update
  fi
  # Updating system
  echo -e "${YELLOW}Updating packages...${NC}"
  nixos-rebuild switch --upgrade --cores 0 --max-jobs auto
  echo -e "${GREEN}Done.${NC}"
}

# Get current OS version
if [ ! -f /etc/os-release ]; then
  echo -e "${RED}/etc/os-release file not found!${NC}"
  exit 1
fi
source /etc/os-release
echo -e "CuriOS current version is ${GREY}${VARIANT_ID}${NC}"

if [ $CHECK_ONLINE -eq 1 ]; then
  get_latest_version
  echo -e "CuriOS latest version is ${GREY}${LATEST_VERSION}${NC}"
  if [ "$LATEST_VERSION" == "$VARIANT_ID" ]; then
    echo -e "${GREEN}System is up-to-date.${NC}"
    exit 0
  else
    if [[ "$LATEST_VERSION" == [0-9][0-9]* ]]; then
      UPGRADABLE=1
      echo -e "${YELLOW}System should be upgraded.${NC}"
      if [ "$EUID" -ge 900 ]; then
        notify-send -a "CuriOS Updater" --urgency=critical "CuriOS ${LATEST_VERSION} is available!" "Launch Curios Manager with Super+Return (+󰌑) >  Upgrade OR in a terminal type: curios-manager"
      fi
    else
      UPGRADABLE=0
      echo -e "${YELLOW}Latest version number is not correct.${NC}"
    fi
  fi
fi

if [ $UPGRADABLE -eq 1 ] && [ $UPGRADE_SYSTEM -eq 1 ]; then
  upgrade_curios
  exit 2
fi

