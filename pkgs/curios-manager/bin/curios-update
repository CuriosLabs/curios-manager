#!/usr/bin/env bash

# CuriOS update script as NixOS package.
#
# Usage:
#       curios-update [options]
# Options:
#     -h, --help         Print this message.
#     --check            Check online if a most recent version of CuriOS exist.
#     --upgrade          Download latest CuriOS and install it. Implies --check option.
#     -v, --verbose      Print more information.
#     --version          Print version number and exit.
#
# Examples:
#    Check online for the latest version:
#      curios-update --check
#    Upgrade system:
#      curios-update --upgrade

set -eu

#------------- Colors -------------#
readonly RED="\033[31;1m"      # Red and bold
readonly GREEN="\033[32;1m"    # Green and bold
readonly BLUE="\033[34;1m"     # Blue and bold
readonly GREY="\033[37;1m"     # Grey and bold
readonly YELLOW="\033[33;1;3m" # Yellow, bold and italic
readonly NC="\033[0m"          # No Color

#------------- Trap for cleanup
TMP_DIR=$(mktemp -d -t curios-update-XXXXXX)
trap 'rm -rf -- "$TMP_DIR"' EXIT

#------------- Print help function
usage() {
  echo -e "${GREY}USAGE:${NC}
  curios-update [options]

${GREY}OPTIONS:${NC}
  ${GREY}-h, --help${NC}         Print this message.
  ${GREY}--check${NC}            Check online if a most recent version of CuriOS exist.
  ${GREY}--export${NC}           Export current CuriOS modules configuration to /etc/nixos/modules.json.
  ${GREY}--update${NC}           Update installed packages, do a Nix collect garbage, warn user if a reboot is necessary.
  ${GREY}--upgrade${NC}          Download latest CuriOS and install it. Implies --check option.
  ${GREY}-v, --verbose${NC}      Print more information.
  ${GREY}--version${NC}          Print version number and exit.

${GREY}EXAMPLES:${NC}
  Check online for the latest CuriOS version:
    ${GREY}curios-update --check${NC}
  Export current modules configuration:
    ${GREY}sudo curios-update --export${NC}
  Upgrade whole system to latest version:
    ${GREY}sudo curios-update --upgrade${NC}
  Update installed packages, Nix garbage collect:
    ${GREY}curios-update --update${NC}"
  exit 0
}

#------------- var init state
readonly SCRIPT_VERSION="0.15"
VERBOSE=0
CHECK_ONLINE=0
EXPORT_MODULES=0
UPDATE_SYSTEM=0
UPGRADE_SYSTEM=0
UPGRADABLE=0
LATEST_VERSION=""
LATEST_SOURCE=""
NIX_CHANNEL_URL=""
SCRIPT_PATH="$(dirname "$0")"

#------------- Scripts arguments parse options
ARGS=$(getopt --longoptions="verbose,version,help,check,export,update,upgrade" --options ":hv" -- "$@")
if [ $# -eq 0 ]; then
  usage
fi

eval set -- "$ARGS"

while true; do
  case "$1" in
  -v | --verbose)
    VERBOSE=1
    shift
    ;;
  -h | --help)
    usage
    ;;
  --check)
    CHECK_ONLINE=1
    shift
    ;;
  --export)
    EXPORT_MODULES=1
    shift
    ;;
  --update)
    UPDATE_SYSTEM=1
    shift
    ;;
  --upgrade)
    UPGRADE_SYSTEM=1
    CHECK_ONLINE=1
    shift
    ;;
  --version)
    echo "$SCRIPT_VERSION"
    exit 0
    ;;
  --)
    shift
    break
    ;;
  *)
    break
    ;;
  esac
done

if [ $VERBOSE -eq 1 ]; then
  echo "Script current path: ${SCRIPT_PATH}"
fi

# This script must be run as root for --upgrade, --update and --export option
if [[ "$EUID" -ne 0 ]] && [[ $UPGRADE_SYSTEM -eq 1 || $UPDATE_SYSTEM -eq 1 || $EXPORT_MODULES -eq 1 ]]; then
  echo -e "${RED}This script MUST be run as root: sudo curios-update --upgrade${NC}" >&2
  exit 1
fi

# Check dependencies
available() { command -v "$1" >/dev/null; }

if ! available notify-send; then
  echo -e "${RED}notify-send command not found!${NC}"
  exit 1
fi
if ! available wget; then
  echo -e "${RED}wget command not found!${NC}"
  exit 1
fi
if ! available curl; then
  echo -e "${RED}curl command not found!${NC}"
  exit 1
fi
if ! available jq; then
  echo -e "${RED}jq command not found!${NC}"
  exit 1
fi
if ! available tar; then
  echo -e "${RED}tar command not found!${NC}"
  exit 1
fi
if ! available fd; then
  echo -e "${RED}fd command not found!${NC}"
  exit 1
fi
if ! available nixos-option; then
  echo -e "${RED}nixos-option command not found!${NC}"
  exit 1
fi
if ! available nix-instantiate; then
  echo -e "${RED}nix-instantiate command not found!${NC}"
  exit 1
fi

# check online latest version
get_latest_version() {
  if [ $VERBOSE -eq 1 ]; then
    echo -e "${BLUE}Checking github sources...${NC}"
  fi
  local LATEST_INFO
  LATEST_INFO=$(curl -f -L --silent "https://api.github.com/repos/CuriosLabs/CuriOS/tags" | jq -r '.[0]')
  LATEST_VERSION=$(echo "$LATEST_INFO" | jq -r '.name')
  LATEST_SOURCE=$(echo "$LATEST_INFO" | jq -r '.tarball_url')
}

# Update Nix packages, system, collect garbage
update_curios() {
  echo -e "${GREEN}Launching Nix garbage collection...${NC}"
  nix-collect-garbage --delete-older-than 7d
  echo -e "${GREEN}Updating CuriOS system...${NC}"
  nixos-rebuild switch --upgrade --cores 0 --max-jobs auto
  echo -e "${GREEN}Updating Nix flakes...${NC}"
  nix profile upgrade --all
  reboot_check
}

# Check if current kernel and nix latest kernel generation are different
# If yes send the user a notification to reboot.
reboot_check() {
  LIST_GEN=$(nixos-rebuild list-generations --json)
  LIST_GEN_KERNEL=$(echo "$LIST_GEN" | jq -r '.[0].kernelVersion')
  if [[ $(uname -r) != "$LIST_GEN_KERNEL" ]]; then
    echo -e "A new kernel was installed - ${YELLOW}You should REBOOT now${NC}."
    # Send a notification to user with UID 1000
    sudo -u "#1000" DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus notify-send -a "System Update" --icon="curios" --urgency=critical --expire-time=8000 "A new kernel was installed - You SHOULD reboot now!"
  fi
}

# Export all NixOS options values from 'curios' to a JSON file
export_curios_modules() {
  echo -e "${GREEN}Exporting CuriOS modules to /etc/nixos/modules.json...${NC}"
  # Get all curios options, filter out errors and derivations
  # then wrap in a nix attribute set and convert to JSON using nix-instantiate
  if ! nixos-option -r curios >/dev/null 2>&1; then
    echo -e "${YELLOW}Warning: 'curios' option set not found. Skipping export.${NC}"
    return
  fi

  # Backup existing file if it exists
  if [ -f /etc/nixos/modules.json ]; then
    local backup_file
    backup_file="/etc/nixos/modules.json.$(date +%Y%m%d_%H%M%S).bak"
    cp /etc/nixos/modules.json "$backup_file"
    echo -e "${BLUE}Backup created: ${backup_file}${NC}"
  fi

  local curios_current_options=""
  curios_current_options=$(nixos-option -r curios 2>/dev/null)
  echo "{$curios_current_options}" | nix-instantiate --eval --strict --json - >/etc/nixos/modules.json ||
    echo -e "${RED}Error: Failed to export CuriOS modules to JSON.${NC}"
}

# Upgrade the system
upgrade_curios() {
  local extracted_source_path=""

  export_curios_modules

  echo -e "${GREEN}Downloading ${LATEST_VERSION} sources...${NC}"
  wget -O "${TMP_DIR}/CuriOS-${LATEST_VERSION}".tar.gz --show-progress "$LATEST_SOURCE"
  mkdir -p "${TMP_DIR}/CuriOS-${LATEST_VERSION}"/ && tar -C "${TMP_DIR}/CuriOS-${LATEST_VERSION}"/ -xzf "${TMP_DIR}/CuriOS-${LATEST_VERSION}".tar.gz
  extracted_source_path=$(fd . "${TMP_DIR}/CuriOS-${LATEST_VERSION}"/ --max-depth 1 --type d | head -n 1)
  echo "Sources extracted to ${extracted_source_path}"
  # Checking extracted source
  if [ ! -f "$extracted_source_path"/configuration.nix ]; then
    echo -e "${RED}configuration.nix file not found!${NC}"
    exit 1
  fi

  # Installing
  echo -e "${GREEN}Installing update...${NC}"
  install -D -m 644 -t /etc/nixos/ "$extracted_source_path"/configuration.nix
  if [ ! -f /etc/nixos/settings.nix ]; then
    install -D -m 644 -t /etc/nixos/ "$extracted_source_path"/settings.nix
    echo -e "${YELLOW}Default settings.nix file installed!${NC} Edit /etc/nixos/settings.nix to match your username."
  fi
  if [ ! -f /etc/nixos/modules.json ]; then
    install -D -m 644 -t /etc/nixos/ "$extracted_source_path"/modules.json
    echo -e "${YELLOW}Default modules.json file installed!${NC} Edit /etc/nixos/modules.json to match your installed CuriOS applications."
  fi
  if [ ! -f /etc/nixos/hardened.json ]; then
    install -D -m 644 -t /etc/nixos/ "$extracted_source_path"/hardened.json
    echo -e "${YELLOW}Default hardened.json file installed!${NC} Edit /etc/nixos/hardened.json with caution."
  fi
  if [ ! -f "$extracted_source_path"/logo.txt ]; then
    install -D -m 644 -t /etc/nixos/ "$extracted_source_path"/logo.txt
  fi
  install -D -m 555 -t /etc/nixos/ "$extracted_source_path"/curios-*
  mkdir -p /etc/nixos/modules/
  cp -r -f "$extracted_source_path"/modules/ /etc/nixos/
  mkdir -p /etc/nixos/pkgs/
  cp -r -f "$extracted_source_path"/pkgs/ /etc/nixos/
  # Updating NixOS channel if necessary
  NIX_CHANNEL_URL=$(grep -oP -m 1 'channel\s*=\s*"\K[^"]+' /etc/nixos/configuration.nix)
  if [ -z "$NIX_CHANNEL_URL" ]; then
    echo -e "${RED}Nix channel not found in configuration.nix!${NC}"
    exit 1
  fi
  if nix-channel --list | grep -q "$NIX_CHANNEL_URL"; then
    echo -e "${BLUE}Nix channel is already up-to-date.${NC}"
  else
    echo -e "${YELLOW}Updating Nix channel...${NC}"
    nix-channel --add "$NIX_CHANNEL_URL" nixos
    nix-channel --update
  fi
  # Updating system
  echo -e "${YELLOW}Updating packages...${NC}"
  nixos-rebuild switch --upgrade --cores 0 --max-jobs auto
  echo -e "${GREEN}Done.${NC}"
}

# Get current OS version
if [ ! -f /etc/os-release ]; then
  echo -e "${RED}/etc/os-release file not found!${NC}"
  exit 1
fi
source /etc/os-release
echo -e "CuriOS current version is ${GREY}${VARIANT_ID}${NC}"

if [ $CHECK_ONLINE -eq 1 ]; then
  get_latest_version
  echo -e "CuriOS latest version is ${GREY}${LATEST_VERSION}${NC}"
  if [ "$LATEST_VERSION" == "$VARIANT_ID" ]; then
    echo -e "${GREEN}System is up-to-date.${NC}"
    exit 0
  else
    if [[ "$LATEST_VERSION" == [0-9][0-9]* ]]; then
      UPGRADABLE=1
      echo -e "${YELLOW}System should be upgraded.${NC}"
      if [ "$EUID" -ge 900 ]; then
        notify-send -a "CuriOS Updater" --urgency=critical "CuriOS ${LATEST_VERSION} is available!" "Launch Curios Manager with Super+Return (+󰌑) >  Upgrade OR in a terminal type: curios-manager"
      fi
    else
      UPGRADABLE=0
      echo -e "${YELLOW}Latest version number is not correct.${NC}"
    fi
  fi
fi

if [ $UPDATE_SYSTEM -eq 1 ]; then
  update_curios
  exit 0
fi

if [ $EXPORT_MODULES -eq 1 ]; then
  export_curios_modules
  exit 0
fi

if [ $UPGRADABLE -eq 1 ] && [ $UPGRADE_SYSTEM -eq 1 ]; then
  upgrade_curios
  exit 2
fi
